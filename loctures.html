<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectures' Videos</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <!-- Firebase initialization script -->
    <script src="loadattendeailfromfirestore.js"></script>
    <style>
        .container {
            display: flex;
            justify-content: space-between;
        }
        .combo-boxes {
            display: flex;
            flex-direction: column;
        }
        .delete-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: lightgray;
            border: none;
            cursor: pointer;
        }
        .delete-button:hover {
            background-color: darkgray;
        }
    </style>
</head>
<body>
    <h3>Lectures' Videos</h3>
    <div class="container">
        <div>
            <table id="lectures-table" border="1" cellpadding="10" cellspacing="0">
                <thead>
                    <tr>
                        <th>Lecturer</th>
                        <th>Last Updated</th>
                        <th>Display the Lecture</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added here dynamically -->
                </tbody>
            </table>
        </div>
        <div class="combo-boxes">
            <label for="lecturer-email"><h3>Lecturer Email</h3></label>
            <select id="lecturer-email" style="width: 250px; height: 30px;"><option value="null"></option></select>
            <label for="lecture-time"><h3>Lecture Time</h3></label>
            <select id="lecture-time" style="width: 250px; height: 30px;"><option value="null"></option></select>
             <button class="delete-button" id="deleteVideo">Delete Selected Video</button>
        </div>
    </div>
<script>
        document.addEventListener('DOMContentLoaded', function() {
            const db = firebase.firestore();
            const storage = firebase.storage();
            const lecturesTableBody = document.querySelector('#lectures-table tbody');
            const lecturerEmailSelect = document.getElementById('lecturer-email');
            const lectureTimeSelect = document.getElementById('lecture-time');
            const deleteButton = document.getElementById('deleteVideo');
            let selectedDocumentId = null;

            function loadLectures(creatorEmail = null, stopRecordingDate = null) {
                let query = db.collection('meetings_his_tbl');

                // Apply filters based on the combo box values
                if (creatorEmail && creatorEmail !== 'null') {
                    query = query.where('creatorEmail', '==', creatorEmail);
                }

                if (stopRecordingDate && stopRecordingDate !== 'null') {
                    const startDate = new Date(stopRecordingDate);
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 1); // End of the day

                    query = query.where('stopRecordingTime', '>=', firebase.firestore.Timestamp.fromDate(startDate))
                                 .where('stopRecordingTime', '<', firebase.firestore.Timestamp.fromDate(endDate));
                }

                // Clear the current table rows
                lecturesTableBody.innerHTML = '';

                query.get()
                    .then(querySnapshot => {
                        querySnapshot.forEach(doc => {
                            const lecture = doc.data();
                            const row = document.createElement('tr');

                            const lecturerCell = document.createElement('td');
                            lecturerCell.textContent = lecture.creatorEmail;

                            const updatedCell = document.createElement('td');
                            updatedCell.textContent = new Date(lecture.stopRecordingTime.seconds * 1000).toLocaleString();

                            const linkCell = document.createElement('td');
                            const link = document.createElement('a');
                            link.href = lecture.videoURL; // Direct link to the video URL
                            link.textContent = "Display the lecture";
                            link.classList.add('video-link');
                            link.setAttribute('data-url', lecture.videoURL);
                            link.setAttribute('target', '_blank'); // Open in new tab
                            linkCell.appendChild(link);

                            row.appendChild(lecturerCell);
                            row.appendChild(updatedCell);
                            row.appendChild(linkCell);

                            row.addEventListener('click', function() {
                                // Remove shadow from any previously selected row
                                const previouslySelected = document.querySelector('.selected-row');
                                if (previouslySelected) {
                                    previouslySelected.classList.remove('selected-row');
                                    previouslySelected.style.backgroundColor = ''; // Reset background color
                                }

                                // Add shadow to the clicked row
                                row.classList.add('selected-row');
                                row.style.backgroundColor = 'lightblue'; // Set the background color to light blue
                                
                                // Set the selected document ID for deletion
                                selectedDocumentId = doc.id;
                            });

                            lecturesTableBody.appendChild(row);
                        });
                    })
                    .catch(error => console.error("Error loading lectures:", error));
            }

            function populateComboBoxes() {
                const uniqueEmails = new Set();
                const uniqueDates = new Set();

                db.collection('meetings_his_tbl').get()
                    .then(querySnapshot => {
                        querySnapshot.forEach(doc => {
                            const lecture = doc.data();

                            // Add unique values to sets
                            uniqueEmails.add(lecture.creatorEmail);

                            // Extract the date part only
                            const lectureDate = new Date(lecture.stopRecordingTime.seconds * 1000);
                            const dateString = lectureDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                            uniqueDates.add(dateString);
                        });

                        // Convert sets to sorted arrays
                        const sortedEmails = Array.from(uniqueEmails).sort();
                        const sortedDates = Array.from(uniqueDates).sort();

                        // Populate the combo boxes with unique and sorted values
                        sortedEmails.forEach(email => {
                            const option = document.createElement('option');
                            option.value = email;
                            option.textContent = email;
                            lecturerEmailSelect.appendChild(option);
                        });

                        sortedDates.forEach(date => {
                            const option = document.createElement('option');
                            option.value = date;
                            option.textContent = date;
                            lectureTimeSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error("Error populating combo boxes:", error));
            }

          function deleteSelectedLecture() {
    if (selectedDocumentId) {
        // Get the lecturer's email from the selected row
        const selectedRow = document.querySelector('.selected-row');
        const selectedLecturerEmail = selectedRow ? selectedRow.cells[0].textContent : null;

        const loggedInEmail = localStorage.getItem('loggedInEmail');

        if (loggedInEmail === selectedLecturerEmail) {
            // Proceed with deletion
            const docRef = db.collection('meetings_his_tbl').doc(selectedDocumentId);

            docRef.get().then(doc => {
                if (doc.exists) {
                    const lecture = doc.data();
                    const videoURL = lecture.videoURL;

                    // Delete the video from Firebase Storage
                    const storageRef = storage.refFromURL(videoURL);
                    storageRef.delete().then(() => {
                        alert('Video deleted successfully from storage.');

                        // Delete the document from Firestore
                        docRef.delete().then(() => {
                            console.log('Document deleted successfully from Firestore.');

                            // Remove the selected row from the table
                            if (selectedRow) {
                                selectedRow.remove();
                            }

                            // Reset selectedDocumentId
                            selectedDocumentId = null;
                        }).catch(error => console.error('Error deleting document:', error));
                    }).catch(error => console.error('Error deleting video from storage:', error));
                }
            }).catch(error => console.error('Error fetching document:', error));
        } else {
            alert('Only the meeting event creator is authorized to delete the video.');
        }
    } else {
        alert('Please select a lecture to delete.');
    }
}

            // Event listeners for combo boxes to trigger filtering
            lecturerEmailSelect.addEventListener('change', () => {
                const selectedEmail = lecturerEmailSelect.value;
                const selectedDate = lectureTimeSelect.value;
                loadLectures(selectedEmail, selectedDate);
            });

            lectureTimeSelect.addEventListener('change', () => {
                const selectedEmail = lecturerEmailSelect.value;
                const selectedDate = lectureTimeSelect.value;
                loadLectures(selectedEmail, selectedDate);
            });

            // Event listener for delete button
            deleteButton.addEventListener('click', deleteSelectedLecture);

            // Initial load
            populateComboBoxes();
            loadLectures();
        });
    </script>
</body>
</html>
