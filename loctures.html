<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectures' Videos</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase initialization script -->
    <script src="loadattendeailfromfirestore.js"></script>
    <style>
        .container {
            display: flex;
            justify-content: space-between;
        }
        .combo-boxes {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <h3>Lectures' Videos</h3>
    <div class="container">
        <div>
            <table id="lectures-table" border="1" cellpadding="10" cellspacing="0">
                <thead>
                    <tr>
                        <th>Lecturer</th>
                        <th>Last Updated</th>
                        <th>Display the Lecture</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added here dynamically -->
                </tbody>
            </table>
        </div>
        <div class="combo-boxes">
            <label for="lecturer-email"><h3>Lecturer Email</h3></label>
            <select id="lecturer-email" style="width: 250px; height: 30px;"><option value="null"></option></select>
            <label for="lecture-time"><h3>Lecture Time</h3></label>
            <select id="lecture-time" style="width: 250px; height: 30px;"><option value="null"></option></select>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const db = firebase.firestore();
    const lecturesTableBody = document.querySelector('#lectures-table tbody');
    const lecturerEmailSelect = document.getElementById('lecturer-email');
    const lectureTimeSelect = document.getElementById('lecture-time');

    function loadLectures(creatorEmail = null, stopRecordingDate = null) {
        let query = db.collection('meetings_his_tbl');

        if (creatorEmail && creatorEmail !== 'null') {
            query = query.where('creatorEmail', '==', creatorEmail);
        }

        if (stopRecordingDate && stopRecordingDate !== 'null') {
            const startOfDay = new Date(stopRecordingDate);
            startOfDay.setHours(0, 0, 0, 0);

            const endOfDay = new Date(stopRecordingDate);
            endOfDay.setHours(23, 59, 59, 999);

            query = query
                .where('stopRecordingTime', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                .where('stopRecordingTime', '<=', firebase.firestore.Timestamp.fromDate(endOfDay));
        }

        lecturesTableBody.innerHTML = '';

        query.get()
            .then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    const lecture = doc.data();
                    const row = document.createElement('tr');

                    // Add the snapshot image to the first column
                    const snapshotCell = document.createElement('td');
                    const snapshotImg = document.createElement('img');
                    snapshotImg.src = lecture.snapshotURL; // Assuming the snapshot URL is stored in the Firestore document
                    snapshotImg.alt = "Snapshot";
                    snapshotImg.style.width = "100px"; // Set the size of the image
                    snapshotImg.style.height = "auto";
                    snapshotCell.appendChild(snapshotImg);
                    row.appendChild(snapshotCell);

                    const lecturerCell = document.createElement('td');
                    lecturerCell.textContent = lecture.creatorEmail;
                    row.appendChild(lecturerCell);

                    const updatedCell = document.createElement('td');
                    updatedCell.textContent = new Date(lecture.stopRecordingTime.seconds * 1000).toLocaleString();
                    row.appendChild(updatedCell);

                    const linkCell = document.createElement('td');
                    const link = document.createElement('a');
                    link.href = lecture.videoURL;
                    link.textContent = "Display the lecture";
                    link.setAttribute('target', '_blank'); // Open in new tab
                    linkCell.appendChild(link);
                    row.appendChild(linkCell);

                    row.addEventListener('click', function() {
                        const previouslySelected = document.querySelector('.selected-row');
                        if (previouslySelected) {
                            previouslySelected.classList.remove('selected-row');
                            previouslySelected.style.backgroundColor = ''; // Reset background color
                        }

                        row.classList.add('selected-row');
                        row.style.backgroundColor = 'lightblue';
                    });

                    lecturesTableBody.appendChild(row);
                });
            })
            .catch(error => console.error("Error loading lectures:", error));
    }

    function populateComboBoxes() {
        const uniqueEmails = new Set();
        const uniqueDates = new Set();

        db.collection('meetings_his_tbl').get()
            .then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    const lecture = doc.data();

                    uniqueEmails.add(lecture.creatorEmail);
                    const date = new Date(lecture.stopRecordingTime.seconds * 1000);
                    uniqueDates.add(date.toDateString()); // Only add the date part
                });

                const sortedEmails = Array.from(uniqueEmails).sort();
                const sortedDates = Array.from(uniqueDates).sort();

                sortedEmails.forEach(email => {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = email;
                    lecturerEmailSelect.appendChild(option);
                });

                sortedDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    lectureTimeSelect.appendChild(option);
                });
            })
            .catch(error => console.error("Error populating combo boxes:", error));
    }

    lecturerEmailSelect.addEventListener('change', () => {
        const selectedEmail = lecturerEmailSelect.value;
        const selectedDate = lectureTimeSelect.value;
        loadLectures(selectedEmail, selectedDate);
    });

    lectureTimeSelect.addEventListener('change', () => {
        const selectedEmail = lecturerEmailSelect.value;
        const selectedDate = lectureTimeSelect.value;
        loadLectures(selectedEmail, selectedDate);
    });

    populateComboBoxes();
    loadLectures();
});
</script>
</body>
</html>
