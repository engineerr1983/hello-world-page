<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Storage Example</title>
    <!-- Other head elements like meta, title, CSS, etc. -->
     <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
     <script src="https://apis.google.com/js/api.js"></script>
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
 <script src="https://js.pusher.com/beams/1.0/push-notifications-cdn.js"></script>
<script>
    // Initialize Pusher Beams
    const beamsClient = new PusherPushNotifications.Client({
      instanceId: 'dd857255-a776-4693-b811-b2caf5ef52b7',
    });

    // Start Pusher Beams
    beamsClient.start()
      .then(() => {
        console.log('Pusher Beams initialized and client started.');
      })
      .catch(console.error);
</script>
  
</head>
<body onload="checkList()">
   <h4 style="font-weight:bold;color:#0000ff;">Enter:Google Meet list of attendees emails with the</h4>
     <h4 style="font-weight:bold;color:#0000ff;font-style:Times New Roman">logged email in blue bold font (REQUIRED)</h4>
    <input type="email" id="attendeeEmail" name="attendeeEmail" placeholder="Enter attendee's email here.." style="height: 30px; width: 300px; background-color: #ddfcf7" required>
    <button id="sendinvit" style="height: 35px;">Add attendees</button>
    <script src="sendinvtoattendee.js" defer></script>
    <button id="joinmeeting" style="height: 35px;">join meeting</button>
   <script src="enabledisablebutton.js"></script>
     <script>
    document.getElementById('joinmeeting').addEventListener('click', function() {
       window.open('https://meet.google.com/pjm-tdbf-bnf', '_blank', 'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes');
        });
        </script>
       <button id="signout" style="height: 35px;">Sign out</button>
     <script>
    document.getElementById('signout').addEventListener('click', function() {
       window.top.location.href = 'loginscreen.html';
    });
  </script>
    <ul id="savedValuesList" style="
        margin: 0;
        padding: 20px;
        list-style-type: none;
        position: relative;
    "></ul> 
    
     <div style="display: flex; justify-content: flex-end; padding: 20px;">
        <h4 
            id="texttip" 
            style=" 
                background-color: #ffffdd;
                font-style: Times New Roman;
                text-align: center;
                font-weight: bold; /* Make font bold */
                position: fixed; /* Fixed position */
                right: 20px; /* Distance from the right edge */
                top: 35px; /* Distance from the top edge */
                display: flex;
                margin: 0; /* Remove default margin */
                /* Additional inline styles here if needed */
            "
        >
           Enter: (Attendees emails-Start time-End time)
           <br>for (Create Meeting), and add to it 
            <br>(Meeting ID) in case of update..
        </h4>
    </div>
    
    <div style="display: flex; justify-content: flex-end; padding: 20px;">
        <input 
            id="meetingid" 
            name="meetingid" 
            placeholder="Enter the Meeting ID here.." 
            style="
                height: 30px; 
                width: 300px; 
                background-color: #ddfcf7; 
                text-align: center;
                font-weight: bold; /* Make font bold */
                position: fixed; /* Absolute position within .container */
                right: 20px; /* Distance from the right edge */
                top: 100px;
                /* Additional inline styles here if needed */
            " 
            required
        >
    </div>
<div style="display: flex; justify-content: flex-end; padding: 20px;">
        <input 
            type="datetime-local" 
            id="starttime" 
            name="starttime" 
            placeholder="Enter the start time here.." 
            style="
                height: 30px; 
                width: 300px; 
                background-color: #ddfcf7; 
                text-align: center;
                font-weight: bold; /* Make font bold */
                 position: fixed; /* Absolute position within .container */
                 right: 20px; /* Distance from the right edge */
                  top: 140px;
                /* Additional inline styles here if needed */
            " 
            required
        >
    </div>
     <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        flatpickr("#starttime", {
            enableTime: true,
            dateFormat: "Y-m-d H:i", // Customize date format
            placeholder: "Enter date and time"
        });
    </script>
    <div style="display: flex; justify-content: flex-end; padding: 20px;">
        <input 
            type="datetime-local" 
            id="endtime" 
            name="endtime" 
            placeholder="Enter the end time here.." 
            style="
                height: 30px; 
                width: 300px; 
                background-color: #ddfcf7; 
                text-align: center;
                font-weight: bold; /* Make font bold */
               position: fixed; /* Absolute position within .container */
               right: 20px; /* Distance from the right edge */
               top: 180px;
                /* Additional inline styles here if needed */
            " 
            required
        >
    </div>
     <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        flatpickr("#endtime", {
            enableTime: true,
            dateFormat: "Y-m-d H:i", // Customize date format
            placeholder: "Enter date and time"
        });
    </script>
    <button id="loadinvit" style="
                height: 35px; 
                text-align: center;
                font-weight: bold; /* Make font bold */
               position: fixed; /* Absolute position within .container */
               right: 35px; /* Distance from the right edge */
               top: 220px;
                /* Additional inline styles here if needed */
            " 
        >Load invit</button>

     <script>
document.addEventListener('DOMContentLoaded', function() {
    const loadInvitButton = document.getElementById('loadinvit');
    
    loadInvitButton.addEventListener('click', function() {
        // Retrieve the access token and logged-in email from localStorage
        const accessToken = localStorage.getItem('accessToken');
        const loggedInEmail = localStorage.getItem('loggedInEmail');
        
        if (accessToken && loggedInEmail) {
            // Function to load meetings for the logged-in email
            function loadMeetings() {
                fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Filter events to include only those where the logged-in email is an attendee
                    const filteredEvents = data.items.filter(event => 
                        event.attendees && event.attendees.some(attendee => attendee.email === loggedInEmail)
                    );

                    // Create a new window and display the meeting data
                    const newWindow = window.open('', '_blank', 'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes');
                    newWindow.document.write('<html><head><title>Meetings</title></head><body>');
                    newWindow.document.write('<h2>Meetings</h2>');
                    newWindow.document.write('<ul>');
                    
                    filteredEvents.forEach(event => {
                        const startTime = new Date(event.start.dateTime).toLocaleString();
                        const endTime = new Date(event.end.dateTime).toLocaleString();
                        const creatorEmail = event.creator.email;
                        const description = event.description || 'No description';
                        const hangoutLink = event.hangoutLink || 'No link available';
                        
                        // Determine if the event is recurring
                        let recurrenceInfo = 'Single event';
                        if (event.recurrence) {
                            recurrenceInfo = 'Recurring event';

                            // Example: Extracting the number of occurrences (if available)
                            const recurrenceRule = event.recurrence[0]; // Recurrence rules like 'RRULE:FREQ=WEEKLY;COUNT=10'
                            const countMatch = recurrenceRule.match(/COUNT=(\d+)/);
                            if (countMatch) {
                                recurrenceInfo += `, Occurs ${countMatch[1]} times`;
                            }

                            // Extract the recurrence frequency (e.g., daily, weekly, monthly)
                            const freqMatch = recurrenceRule.match(/FREQ=(\w+)/);
                            if (freqMatch) {
                                recurrenceInfo += `, Frequency: ${freqMatch[1].toLowerCase()}`;
                            }
                        }

                        newWindow.document.write(`
                            <li>
                                <strong>Start Time:</strong> ${startTime}<br>
                                <strong>End Time:</strong> ${endTime}<br>
                                <strong>Creator's Email:</strong> ${creatorEmail}<br>
                                <strong>Description:</strong> ${description}<br>
                                <strong>Meeting Link:</strong> <a href="${hangoutLink}" target="_blank">${hangoutLink}</a><br>
                                <strong>Meeting Type:</strong> ${recurrenceInfo}
                            </li>
                        `);
                    });

                    newWindow.document.write('</ul>');
                    newWindow.document.write('</body></html>');
                    newWindow.document.close();
                })
                .catch(error => {
                    console.error('Error loading meetings:', error);
                    alert('There was an error loading the meetings.');
                });
            }
            
            loadMeetings();
        } else {
            alert('Access token or logged-in email is missing.');
        }
    });
});
</script>


    
     <button id="updateinvit" style=" height: 35px; 
                text-align: center;
                font-weight: bold; /* Make font bold */
               position: fixed; /* Absolute position within .container */
               right: 120px; /* Distance from the right edge */
               top: 220px;
                /* Additional inline styles here if needed */
            ">Update invit</button>
<script>
document.getElementById('updateinvit').addEventListener('click', async function() {
    const accessToken = localStorage.getItem('accessToken');
    const loggedEmail = localStorage.getItem('loggedEmail');
    
    // Fetch the user's events
    const eventsResponse = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?maxResults=10&q=${loggedEmail}&access_token=${accessToken}`);
    const eventsData = await eventsResponse.json();
    let events = eventsData.items.filter(event => event.creator.email === loggedEmail);

    let currentIndex = 0;
    function renderEvent() {
        const event = events[currentIndex];
        let updateWindow = window.open('', '_blank', 'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes');
        
        updateWindow.document.write(`
            <html>
            <head><title>Update Meeting</title></head>
            <body>
                <label>Start Time: <input type="datetime-local" id="startTime" value="${new Date(event.start.dateTime).toISOString().slice(0, 16)}"></label><br><br>
                <label>End Time: <input type="datetime-local" id="endTime" value="${new Date(event.end.dateTime).toISOString().slice(0, 16)}"></label><br><br>
                <label>Description: <input type="text" id="description" value="${event.description || ''}"></label><br><br>
                <label>Attendees:</label><br>
                <input type="email" id="newAttendeeEmail" placeholder="Add attendee"><button id="addAttendee">Add Attendee</button><br><br>
                <ul id="attendees">
                    ${event.attendees ? event.attendees.map(att => `<li>${att.email}</li>`).join('') : ''}
                </ul><br>
                <button id="deleteAttendee">Delete Attendee</button><br><br>
                <button id="prevEvent">Previous</button>
                <button id="nextEvent">Next</button><br><br>
                <button id="updateEvent">Update Meeting</button>
                <button id="deleteEvent">Delete Meeting</button>
            </body>
            </html>
        `);

        // Handling the add attendee action
        updateWindow.document.getElementById('addAttendee').addEventListener('click', function() {
            const newEmail = updateWindow.document.getElementById('newAttendeeEmail').value;
            const attendeesList = updateWindow.document.getElementById('attendees');
            if (!newEmail) {
                alert('Please enter an email.');
                return;
            }
            const existingEmails = Array.from(attendeesList.children).map(li => li.textContent);
            if (existingEmails.includes(newEmail)) {
                alert('Attendee already added.');
            } else {
                attendeesList.innerHTML += `<li>${newEmail}</li>`;
            }
        });

        // Handling the delete attendee action
        updateWindow.document.getElementById('deleteAttendee').addEventListener('click', function() {
            const attendeesList = updateWindow.document.getElementById('attendees');
            attendeesList.removeChild(attendeesList.lastElementChild);
        });

        // Navigate to previous or next event
        updateWindow.document.getElementById('prevEvent').addEventListener('click', function() {
            if (currentIndex > 0) {
                currentIndex--;
                renderEvent();
            }
        });
        updateWindow.document.getElementById('nextEvent').addEventListener('click', function() {
            if (currentIndex < events.length - 1) {
                currentIndex++;
                renderEvent();
            }
        });

        // Update event
        updateWindow.document.getElementById('updateEvent').addEventListener('click', async function() {
            const updatedEvent = {
                start: { dateTime: new Date(updateWindow.document.getElementById('startTime').value).toISOString() },
                end: { dateTime: new Date(updateWindow.document.getElementById('endTime').value).toISOString() },
                description: updateWindow.document.getElementById('description').value,
                attendees: Array.from(updateWindow.document.getElementById('attendees').children).map(li => ({ email: li.textContent }))
            };

            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${event.id}?access_token=${accessToken}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedEvent)
            });

            if (response.ok) {
                alert('Meeting updated successfully.');
            } else {
                alert('Failed to update meeting.');
            }
        });

        // Delete event
        updateWindow.document.getElementById('deleteEvent').addEventListener('click', async function() {
            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${event.id}?access_token=${accessToken}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Meeting deleted successfully.');
                events.splice(currentIndex, 1);
                if (events.length > 0) {
                    if (currentIndex >= events.length) currentIndex--;
                    renderEvent();
                } else {
                    updateWindow.close();
                }
            } else {
                alert('Failed to delete meeting.');
            }
        });
    }

    if (events.length > 0) {
        renderEvent();
    } else {
        alert('No meetings found.');
    }
});

            </script>
    
     <button id="createinvit" style=" height: 35px; 
                text-align: center;
                font-weight: bold; /* Make font bold */
               position: fixed; /* Absolute position within .container */
               right: 220px; /* Distance from the right edge */
               top: 220px;
                /* Additional inline styles here if needed */
            " 
         >Create invit</button>
    
 <script>
        document.addEventListener('DOMContentLoaded', function() {
            const savedValuesList = document.getElementById('savedValuesList');
            const startTimeInput = document.getElementById('starttime');
            const endTimeInput = document.getElementById('endtime');
            const createInvitButton = document.getElementById('createinvit');

            function validateInputs() {
            if (startTimeInput.value === '' || endTimeInput.value === '') {
                alert("Please enter both start time and end time.");
                return false; // Return false to stop further execution
            }
            return true; // Return true if inputs are valid
        }
            function generateRequestId() {
    return 'req-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
}

            // Retrieve the access token from localStorage
            const accessToken = localStorage.getItem('accessToken');
            console.log('access token is:', accessToken);

            //Pass the access token to env variable in Vercel

               // Send the access token to the Vercel endpoint
    fetch('https://hello-world-page.vercel.app/api/store-token4', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ accessToken })
    })
    .then(response => {
        if (response.ok) {
            alert('Access token sent to Vercel');
        } else {
            alert('Failed to send access token');
        }
    })
    .catch(error => {
        console.error('Error sending access token:', error);
        alert('An error occurred while sending the access token');
    });

        // Function to create a recurring meeting event
function createMeetingEvent() {
    if (savedValuesList.children.length > 0 && accessToken) {
        const attendees = Array.from(savedValuesList.children).map(item => ({ email: item.textContent }));
        const startTime = new Date(startTimeInput.value).toISOString();
        const endTime = new Date(endTimeInput.value).toISOString();
        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone; // Get the browser's time zone
        const event = {
            summary: 'Recurring Meeting',
            start: { dateTime: startTime, timeZone: timeZone },
            end: { dateTime: endTime, timeZone: timeZone },
            recurrence: ['RRULE:FREQ=DAILY;COUNT=10'], // Example: Daily for 10 occurrences
            attendees: attendees,
            conferenceData: {
                createRequest: {
                    requestId: generateRequestId(), // Generate a unique request ID
                    conferenceSolutionKey: {
                        type: "hangoutsMeet"
                    }
                }
            }
        };
        console.log('attendees', attendees);
        fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events?conferenceDataVersion=1', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(event),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error creating event:', data.error.message);
            } else {
                console.log('Event created:', data);
                // Extract the necessary information from the response
                const conferenceId = data.conferenceData.createRequest.conferenceSolutionKey.type;
                const createdDate = new Date(data.created).toLocaleString();
                const creatorEmail = data.creator.email;
                const hangoutLink = data.hangoutLink;
                const startTime = new Date(data.start.dateTime).toLocaleString();
                const endTime = new Date(data.end.dateTime).toLocaleString();
                const recurrence = data.recurrence ? data.recurrence.join(", ") : 'None';
                const status = data.status;
                const summary = data.summary;

                // Create the alert message
                const alertMessage = `
                    Creation of the meeting event successful, details:
                    Conference ID: ${conferenceId}
                    Created Date: ${createdDate}
                    Creator Email: ${creatorEmail}
                    Hangout Link: ${hangoutLink}
                    Start Time: ${startTime}
                    End Time: ${endTime}
                    Recurrence: ${recurrence}
                    Status: ${status}
                    Summary: ${summary}
                `;

                // Display the alert
                alert(alertMessage);
            }
        })
        .catch(error => {
            console.error('Error creating event:', error);
            alert('There was an error creating the meeting event.');
        });
    } else {
        console.error('Access token is missing or no attendees available.');
    }
}
            

            // Add click event listener to the button
            createInvitButton.addEventListener('click', function() {
                 if (validateInputs()) { 
                createMeetingEvent();
                 }
            });
        });
    </script>

    
</body>
</html>
